<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>æ­·å²ç´€éŒ„ - ç¯€èƒ½ç¿’æ…£è¿½è¹¤å™¨</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ç¯€èƒ½ç¿’æ…£è¿½è¹¤å™¨</h1>
    <p class="subtitle">å°ç¿’æ…£å¸¶ä¾†å¤§å½±éŸ¿ â€” SDGs 7 / 11 / 13</p>
    <nav>
      <a href="home.html"><button>ğŸ  é¦–é </button></a>
      <a href="behavior.html"><button>ğŸ“‹ è¡Œç‚ºè¡¨</button></a>
      <a href="history.html"><button>ğŸ“˜ æ­·å²ç´€éŒ„</button></a>
      <a href="medals.html"><button>ğŸ… çç‰Œç´€éŒ„</button></a>
    </nav>

        <section class="card" id="fixed-animation">
      <h3>æœ¬é€±é€²åº¦èˆ‡èµ°è·¯å°å‹•ç•«</h3>
      <div id="track" class="track"><div id="walker" class="walker">ğŸš¶â€â™‚ï¸</div></div>
      <div class="row small">
        <div>ä»Šæ—¥å¾—åˆ†ï¼š<span id="today-points">0</span> é»</div>
        <div>é€²åº¦ï¼š<span id="week-points-2">0</span>/<span id="weekly-goal-2"></span></div>
      </div>
      <div id="medal-note" class="small muted"></div>
    </section>
  </header>

  <main class="page">
    <section class="card">
      <h2>æ­·å²ç´€éŒ„</h2>
      <div id="history-list"></div>
      <div class="pager"><button id="prev-page">ä¸Šä¸€é </button><span id="page-info"></span><button id="next-page">ä¸‹ä¸€é </button></div>
    </section>
  </main>

    <script src="main.js"></script>
    <script src="history.js"></script>

  <!-- Firebaseï¼šæ­·å²ç´€éŒ„é ï¼Œå¾ Firestore è®€å– testDailyRecords -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // âœ… å’Œå…¶ä»–é é¢ä¸€æ¨£çš„è¨­å®šï¼ˆè¨˜å¾—ç”¨é€™çµ„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyC1j-dogTtBDR3pt5KehghpJFbRbLcIpM",
      authDomain: "energy-e1c4b.firebaseapp.com",
      projectId: "energy-e1c4b",
      storageBucket: "energy-e1c4b.firebasestorage.app",
      messagingSenderId: "349372717450",
      appId: "1:349372717450:web:1b1ebc5b0066a4acc89073"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    console.log("Firebase: history.html åˆå§‹åŒ–å®Œæˆ");

    const historyList = document.getElementById("history-list");
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageInfo = document.getElementById("page-info");

    // å…ˆæŠŠåŸæœ¬çš„ä¸Šä¸€é  / ä¸‹ä¸€é é—œæ‰ï¼ˆæš«æ™‚ä¸ç”¨æœ¬åœ°åˆ†é ï¼‰
    if (prevBtn) prevBtn.disabled = true;
    if (nextBtn) nextBtn.disabled = true;
    if (pageInfo) pageInfo.textContent = "ç”± Firebase è¼‰å…¥";

    async function loadHistoryFromFirebase() {
      try {
        // ç›®å‰è¡Œç‚ºè¡¨æ˜¯å¯«åˆ° testDailyRecords é€™å€‹é›†åˆ
        const snap = await getDocs(collection(db, "testDailyRecords"));

        if (snap.empty) {
          historyList.innerHTML = "<p>ç›®å‰ Firebase ä¸­æ²’æœ‰ä»»ä½•æ­·å²ç´€éŒ„ã€‚</p>";
          alert("Firebase ä¸­å°šç„¡æ­·å²è³‡æ–™");
          return;
        }

        // æ”¶é›†ä¸¦ä¾æ—¥æœŸæ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
        const items = [];
        snap.forEach(docSnap => {
          const data = docSnap.data();
          items.push({
            id: docSnap.id,
            date: data.date || docSnap.id,
            points: data.points || 0,
            note: data.note || "ï¼ˆç„¡ï¼‰",
            createdAt: data.createdAt || null
          });
        });

        items.sort((a, b) => b.date.localeCompare(a.date)); // å­—ä¸²æ—¥æœŸæ’åº

        let html = "";
        for (const item of items) {
          const timeText = item.createdAt && item.createdAt.toDate
            ? item.createdAt.toDate().toLocaleString("zh-TW")
            : "æ™‚é–“æœªè¨˜éŒ„";

          html += `
            <div class="history-item">
              <h3>${item.date} â€” ${item.points} é»</h3>
              <p><strong>å‚™è¨»ï¼š</strong>${item.note}</p>
              <p class="small muted">å¯«å…¥æ™‚é–“ï¼š${timeText}</p>
              <hr>
            </div>
          `;
        }

        historyList.innerHTML = html;
        if (pageInfo) pageInfo.textContent = `å…± ${items.length} ç­†ç´€éŒ„`;
        alert("âœ… å·²æˆåŠŸå¾ Firebase è¼‰å…¥æ­·å²ç´€éŒ„ï¼");

      } catch (err) {
        console.error("è®€å– Firebase å¤±æ•—ï¼š", err);
        alert("è®€å– Firebase å¤±æ•—ï¼Œè«‹æ‰“é–‹ F12 çš„ Console æŸ¥çœ‹éŒ¯èª¤è¨Šæ¯");
      }
    }

    // é€²å…¥é é¢å°±è®€ä¸€æ¬¡
    loadHistoryFromFirebase();
  </script>
</body>
</html>

</body>
</html>